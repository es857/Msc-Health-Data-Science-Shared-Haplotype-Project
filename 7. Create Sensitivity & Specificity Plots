import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import glob
import re

# Load all TSV files matching pattern
files = glob.glob("shared_regions_dist*_vars*_rare*_no_gene_filter.tsv")

# Pattern to extract parameters
pattern = re.compile(r"dist(\d+)_vars(\d+)_rare([\d.]+)")

results = []

for file in files:
    match = pattern.search(file)
    if match:
        dist, vars_, rare = match.groups()
        df = pd.read_csv(file, sep="\t", header=None)
        df.columns = [
            "chrom", "start", "end", "n_variants", "n_individuals", "individuals",
            "mode", "err_left", "err_right", "n_ultra_rare", "filter"
        ]
        
        total = len(df)
        true_matches = 0

        for inds in df["individuals"]:
            ids = inds.split(",")
            prefixes = set(id[:5] for id in ids)
            if len(prefixes) == 1:
                true_matches += 1

        results.append({
            "dist": int(dist),
            "n_vars": int(vars_),
            "rare": float(rare),
            "total_regions": total,
            "true_matches": true_matches,
            "percent_true": 100 * true_matches / total if total > 0 else 0
        })

res_df = pd.DataFrame(results)

# --- Figure 1: Bar Plot ---
plt.figure(figsize=(10, 6))
sns.barplot(data=res_df, x="n_vars", y="percent_true", hue="dist")
plt.title("Percentage of True Matches by Parameters")
plt.ylabel("True Matches (%)")
plt.xlabel("Min Variants")
plt.legend(title="Cluster Distance")
plt.tight_layout()
plt.savefig("figure1_barplot.png")

# --- Figure 2: Sensitivity vs Specificity ---
plt.figure(figsize=(8, 6))
sns.scatterplot(data=res_df, x="percent_true", y="true_matches", hue="n_vars", palette="tab10", style="dist")
plt.title("Sensitivity vs Specificity")
plt.xlabel("Specificity (% True Matches)")
plt.ylabel("Sensitivity (True Match Count)")
plt.legend(title="Min Variants / Distance")
plt.tight_layout()
plt.savefig("figure2_tradeoff.png")
